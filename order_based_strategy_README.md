# åŸºäºäº¤æ˜“æ‰€æŒ‚å•çš„è¶‹åŠ¿ç­–ç•¥ - æ–‡æ¡£

## ğŸ“‹ ç›®å½•
1. [æ ¸å¿ƒæ¦‚å¿µ](#æ ¸å¿ƒæ¦‚å¿µ)
2. [ç­–ç•¥å‚æ•°](#ç­–ç•¥å‚æ•°)
3. [çŠ¶æ€æœºæµç¨‹](#çŠ¶æ€æœºæµç¨‹)
4. [è¯¦ç»†æ‰§è¡Œæ­¥éª¤](#è¯¦ç»†æ‰§è¡Œæ­¥éª¤)
5. [æŠ€æœ¯å®ç°](#æŠ€æœ¯å®ç°)
6. [æ³¨æ„äº‹é¡¹](#æ³¨æ„äº‹é¡¹)
7. [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

---

## æ ¸å¿ƒæ¦‚å¿µ

### è®¾è®¡æ€æƒ³
æœ¬ç­–ç•¥ä¸ `all_in_one.py` çš„æ ¸å¿ƒåŒºåˆ«åœ¨äºï¼š
- âŒ **all_in_one.py**: å®æ—¶ç›‘æ§ä»·æ ¼ï¼ŒPythonä»£ç ä¸»åŠ¨æ‰§è¡Œäº¤æ˜“ï¼ˆè½®è¯¢æ¨¡å¼ï¼‰
- âœ… **order_based_strategy.py**: å°†ç­–ç•¥é€»è¾‘è½¬åŒ–ä¸ºäº¤æ˜“æ‰€åŸç”Ÿè®¢å•ï¼Œä¾é äº¤æ˜“æ‰€è‡ªåŠ¨æ‰§è¡Œï¼ˆäº‹ä»¶é©±åŠ¨ï¼‰

### ä¼˜åŠ¿
1. **ä½å»¶è¿Ÿ**: è®¢å•åœ¨äº¤æ˜“æ‰€æœåŠ¡å™¨æ‰§è¡Œï¼Œæ— éœ€Pythonä»£ç è½®è¯¢
2. **é«˜å¯é **: å³ä½¿æœºå™¨äººæ–­çº¿ï¼Œè®¢å•ä»åœ¨äº¤æ˜“æ‰€ç”Ÿæ•ˆ
3. **ä½èµ„æº**: åªéœ€æ¯2ç§’æ£€æŸ¥ä¸€æ¬¡ä»“ä½å˜åŒ–ï¼ŒCPU/å†…å­˜å ç”¨æä½
4. **ç²¾ç¡®æ‰§è¡Œ**: åˆ©ç”¨äº¤æ˜“æ‰€çš„ STOP_MARKETã€TRAILING_STOP_MARKET ç­‰é«˜çº§è®¢å•ç±»å‹

### æ ¸å¿ƒæœºåˆ¶
é€šè¿‡**ä»“ä½å˜åŒ–æ£€æµ‹**è‡ªåŠ¨æ¨è¿›çŠ¶æ€ï¼š
- æ¯2ç§’æŸ¥è¯¢ä¸€æ¬¡æŒä»“æ•°é‡
- å½“ä»“ä½ä» 0% â†’ 50% â†’ 100% â†’ 0% å˜åŒ–æ—¶ï¼Œè‡ªåŠ¨è§¦å‘å¯¹åº”çš„æŒ‚å•åŠ¨ä½œ

---

## ç­–ç•¥å‚æ•°

### é…ç½®åˆ‡æ¢
æ–‡ä»¶å¼€å¤´æœ‰ `REAL` å˜é‡æ§åˆ¶å®ç›˜/æ¨¡æ‹Ÿç›˜å‚æ•°ï¼š
```python
REAL = False  # False=æ¨¡æ‹Ÿç›˜(å‚æ•°ç¼©å°20å€), True=å®ç›˜
```

### å‚æ•°è¯´æ˜

| å‚æ•°å | å®ç›˜å€¼ | æ¨¡æ‹Ÿç›˜å€¼ | è¯´æ˜ |
|--------|--------|----------|------|
| `atr_period` | 20 | 20 | ATRè®¡ç®—å‘¨æœŸï¼ˆå¤©ï¼‰ |
| `sl_for_size` | 0.35 | 0.35 | ä»“ä½è®¡ç®—ï¼šæ»¡ä»“ = æœ€å¤§äºæŸ / (0.35 Ã— ATR) |
| `sl_atr` | 0.6 | 0.03 | åº•ä»“æ­¢æŸï¼š-0.6 ATR |
| `add_trigger` | 0.1 | 0.005 | åŠ ä»“è§¦å‘ï¼šæµ®ç›ˆ 0.1 ATR |
| `full_sl_atr` | 0.3 | 0.015 | æ»¡ä»“æ­¢æŸï¼š-0.3 ATR |
| `trail_activation` | 0.3 | 0.015 | è·Ÿè¸ªæ­¢ç›ˆæ¿€æ´»ï¼š0.3 ATR |
| `trail_callback` | 0.15 | 0.0075 | è·Ÿè¸ªæ­¢ç›ˆå›è°ƒï¼š0.15 ATR |
| `tp1_atr` / `tp1_pct` | 0.35 / 30% | 0.0175 / 30% | æ­¢ç›ˆ1ï¼š0.35 ATRï¼Œå¹³30% |
| `tp2_atr` / `tp2_pct` | 0.45 / 40% | 0.0225 / 40% | æ­¢ç›ˆ2ï¼š0.45 ATRï¼Œå¹³40% |
| `tp3_atr` / `tp3_pct` | 0.6 / 20% | 0.03 / 20% | æ­¢ç›ˆ3ï¼š0.6 ATRï¼Œå¹³20% |

**æ³¨æ„**: æ¨¡æ‹Ÿç›˜å‚æ•°ç¼©å°20å€æ˜¯ä¸ºäº†å¿«é€Ÿè§¦å‘ï¼Œä¾¿äºæµ‹è¯•ã€‚

---

## çŠ¶æ€æœºæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    çŠ¶æ€è½¬æ¢æµç¨‹å›¾                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

   IDLE (ç©ºé—²)
     â”‚
     â”‚ ç”¨æˆ·é€‰æ‹©å¸ç§ã€æ–¹å‘ã€å…¥åœºæ¨¡å¼ã€æœ€å¤§äºæŸ
     â†“
   WAIT_CONFIRM (ç­‰å¾…ç¡®è®¤)
     â”‚
     â”‚ ç”¨æˆ·ç‚¹å‡»"ç¡®è®¤å¼€ä»“"
     â”‚ â†’ æ ¹æ®æ¨¡å¼æŒ‚å…¥åœºå•ï¼ˆå¸‚ä»·/é™ä»·/è·Ÿè¸ªå•ï¼‰
     â†“
   WAIT_ENTRY (ç­‰å¾…å…¥åœº)
     â”‚
     â”‚ æ£€æµ‹åˆ°ä»“ä½: 0% â†’ 50%
     â”‚ â†’ è®°å½•åº•ä»“å‡ä»·
     â”‚ â†’ æŒ‚æ­¢æŸå•ï¼ˆ-0.6 ATRï¼ŒåŠä»“ï¼‰
     â”‚ â†’ æŒ‚åŠ ä»“è§¦å‘å•ï¼ˆ+0.1 ATRï¼ŒåŠä»“ï¼‰
     â†“
   ENTRY_DONE (å®Œæˆå…¥åœº)
     â”‚
     â”‚ æ£€æµ‹åˆ°ä»“ä½: 50% â†’ 100%
     â”‚ â†’ æ’¤é”€æ‰€æœ‰æ—§è®¢å•
     â”‚ â†’ æŒ‚æ–°æ­¢æŸå•ï¼ˆ-0.3 ATRï¼Œæ»¡ä»“ï¼‰
     â”‚ â†’ æŒ‚è·Ÿè¸ªæ­¢ç›ˆå•ï¼ˆæ¿€æ´»0.3 ATRï¼Œå›è°ƒ0.15 ATRï¼‰
     â”‚ â†’ æŒ‚3ä¸ªé™ä»·æ­¢ç›ˆå•ï¼ˆ0.35/0.45/0.6 ATRï¼‰
     â†“
   WAIT_EXIT (ç­‰å¾…ç¦»åœº)
     â”‚
     â”‚ æ£€æµ‹åˆ°ä»“ä½: 100% â†’ 0%
     â”‚ â†’ ç­–ç•¥ç»“æŸ
     â†“
   IDLE (è¿”å›ç©ºé—²)
```

---

## è¯¦ç»†æ‰§è¡Œæ­¥éª¤

### å‡†å¤‡é˜¶æ®µ
```python
# 1. è®¡ç®—å‰20æ—¥ATRï¼ˆæ’é™¤ä»Šæ—¥æœªå®ŒæˆKçº¿ï¼‰
atr = get_atr(exchange, symbol, period=20, exclude_today=True)

# 2. è®¡ç®—æ»¡ä»“æ•°é‡
full_amount = max_loss / (0.35 * atr)

# 3. å¯åŠ¨2ç§’å®šæ—¶æ£€æŸ¥ä»“ä½
check_position_and_update_state()  # æ¯2ç§’æ‰§è¡Œ
```

---

### æ­¥éª¤1: ç”¨æˆ·é€‰æ‹©å‚æ•° (IDLE â†’ WAIT_CONFIRM)

**ç•Œé¢è¾“å…¥**:
- å¸ç§: BTC_USDT / ETH_USDT / SOL_USDT ç­‰
- æ–¹å‘: åšå¤š(buy) / åšç©º(sell)
- å…¥åœºæ¨¡å¼:
  1. å¸‚ä»·å…¥åœº
  2. é™ä»·å…¥åœº
  3. å¸‚ä»·æ¿€æ´»è·Ÿè¸ªå…¥åœº
  4. é™ä»·æ¿€æ´»è·Ÿè¸ªå…¥åœº
- æœ€å¤§äºæŸ: å¦‚ 50 USDT
- è§¦å‘ä»·æ ¼: (ä»…é™ä»·æ¨¡å¼éœ€è¦)

**ç³»ç»Ÿè®¡ç®—**:
```python
atr_val = è®¡ç®—å‰20æ—¥ATR
full_amount = max_loss / (0.35 * atr_val)
base_amount = full_amount * 0.5  # åº•ä»“50%
```

**æ˜¾ç¤ºç¡®è®¤ä¿¡æ¯**:
```
========================================
å¸ç§: BTC_USDT
æ–¹å‘: åšå¤š ğŸŸ¢
å…¥åœºæ¨¡å¼: å¸‚ä»·æ¿€æ´»è·Ÿè¸ªå…¥åœº
å½“å‰ä»·æ ¼: 95000
ATRå€¼: 2500
æœ€å¤§äºæŸ: 50 USDT
----------------------------------------
åº•ä»“æ•°é‡: 0.0286 BTC
åº•ä»“ä»·å€¼: 2714 USDT
æ»¡ä»“æ•°é‡: 0.0571 BTC
æ»¡ä»“ä»·å€¼: 5428 USDT
========================================
```

---

### æ­¥éª¤2: ç¡®è®¤å¼€ä»“å¹¶æŒ‚å…¥åœºå• (WAIT_CONFIRM â†’ WAIT_ENTRY)

ç”¨æˆ·ç‚¹å‡»"ç¡®è®¤å¼€ä»“"åï¼Œæ ¹æ®å…¥åœºæ¨¡å¼æ‰§è¡Œï¼š

#### æ¨¡å¼1: å¸‚ä»·å…¥åœº
```python
# ç›´æ¥ä¸‹å¸‚ä»·å•ï¼Œç«‹å³æˆäº¤
place_market(symbol="BTCUSDT", side="BUY", quantity=0.0286)
```

#### æ¨¡å¼2: é™ä»·å…¥åœº
```python
# æŒ‚é™ä»·å•ï¼Œç­‰å¾…ä»·æ ¼è§¦è¾¾
place_limit(symbol="BTCUSDT", side="BUY", quantity=0.0286, price=94000)
```

#### æ¨¡å¼3: å¸‚ä»·æ¿€æ´»è·Ÿè¸ªå…¥åœº
```python
# æŒ‚è·Ÿè¸ªå•ï¼Œç«‹å³æ¿€æ´»ï¼Œå›è°ƒåå…¥åœº
# å›è°ƒç‡ = (0.1 ATR Ã— atr_val) / current_price Ã— 100%
# ä¾‹: (0.1 Ã— 2500) / 95000 Ã— 100% = 0.26%
place_trailing_stop(
    symbol="BTCUSDT",
    side="BUY",
    quantity=0.0286,
    callback_rate=0.26,  # 0.26%å›è°ƒ
    activation_price=0   # ç«‹å³æ¿€æ´»
)
```

#### æ¨¡å¼4: é™ä»·æ¿€æ´»è·Ÿè¸ªå…¥åœº
```python
# æŒ‚å¸¦æ¿€æ´»ä»·çš„è·Ÿè¸ªå•ï¼Œä»·æ ¼è¾¾åˆ°æ¿€æ´»ä»·åå¼€å§‹è·Ÿè¸ª
place_trailing_stop(
    symbol="BTCUSDT",
    side="BUY",
    quantity=0.0286,
    callback_rate=0.26,
    activation_price=94000  # ä»·æ ¼è·Œåˆ°94000æ‰æ¿€æ´»
)
```

---

### æ­¥éª¤3: åº•ä»“å»ºç«‹åæŒ‚å• (WAIT_ENTRY â†’ ENTRY_DONE)

**è§¦å‘æ¡ä»¶**: æ£€æµ‹åˆ°ä»“ä½ä» 0 å˜ä¸º 50%æ»¡ä»“

**æ‰§è¡ŒåŠ¨ä½œ**:

#### 3.1 è®°å½•åº•ä»“å‡ä»·
```python
base_price = ä»äº¤æ˜“æ‰€è·å–çš„æŒä»“å‡ä»·  # å¦‚ 94500
```

#### 3.2 æŒ‚æ­¢æŸå•ï¼ˆ-0.6 ATRï¼ŒåŠä»“ï¼‰
```python
# åšå¤š: æ­¢æŸå–å‡º(SELL)ï¼Œåšç©º: æ­¢æŸä¹°å…¥(BUY)
sl_price = base_price - (direction Ã— 0.6 Ã— atr_val)
# ä¾‹: 94500 - (1 Ã— 0.6 Ã— 2500) = 93000

place_stop_market(
    symbol="BTCUSDT",
    side="SELL",           # åšå¤šæ—¶å¹³ä»“=å–å‡º
    quantity=0.0286,       # åŠä»“
    stop_price=93000,
    reduce_only=True       # ğŸ”´ å…³é”®ï¼šä»…å¹³ä»“ï¼Œé˜²æ­¢åå‘å¼€ä»“
)
```

#### 3.3 æŒ‚åŠ ä»“è§¦å‘å•ï¼ˆ+0.1 ATRï¼ŒåŠä»“ï¼‰
```python
# æµ®ç›ˆ0.1 ATRæ—¶è§¦å‘å¸‚ä»·åŠ ä»“
add_trigger = base_price + (direction Ã— 0.1 Ã— atr_val)
# ä¾‹: 94500 + (1 Ã— 0.1 Ã— 2500) = 94750

place_stop_market(
    symbol="BTCUSDT",
    side="BUY",            # åšå¤šæ—¶åŠ ä»“=ä¹°å…¥
    quantity=0.0286,       # åŠ ä»“åŠä»“åˆ°æ»¡ä»“
    stop_price=94750,
    reduce_only=False      # åŠ ä»“ï¼Œä¸æ˜¯å¹³ä»“
)
```

---

### æ­¥éª¤4: æ»¡ä»“åæ›´æ–°æŒ‚å• (ENTRY_DONE â†’ WAIT_EXIT)

**è§¦å‘æ¡ä»¶**: æ£€æµ‹åˆ°ä»“ä½ä» 50% å˜ä¸º 100%

**æ‰§è¡ŒåŠ¨ä½œ**:

#### 4.1 æ’¤é”€æ‰€æœ‰æ—§è®¢å•
```python
# æ’¤é”€æ­¥éª¤3çš„æ­¢æŸå•å’ŒåŠ ä»“è§¦å‘å•
cancel_all_orders(symbol="BTCUSDT")
```

#### 4.2 æŒ‚æ–°æ­¢æŸå•ï¼ˆ-0.3 ATRï¼Œæ»¡ä»“ï¼‰
```python
# æ»¡ä»“åæ­¢æŸæ›´ç´§
full_sl = base_price - (direction Ã— 0.3 Ã— atr_val)
# ä¾‹: 94500 - (1 Ã— 0.3 Ã— 2500) = 93750

place_stop_market(
    symbol="BTCUSDT",
    side="SELL",
    quantity=0.0571,       # æ»¡ä»“
    stop_price=93750,
    reduce_only=True
)
```

#### 4.3 æŒ‚è·Ÿè¸ªæ­¢ç›ˆå•ï¼ˆæ¿€æ´»0.3 ATRï¼Œå›è°ƒ0.15 ATRï¼Œæ»¡ä»“ï¼‰
```python
# æ¿€æ´»ä»·
activation = base_price + (direction Ã— 0.3 Ã— atr_val)
# ä¾‹: 94500 + (1 Ã— 0.3 Ã— 2500) = 95250

# å›è°ƒç‡ = (0.15 Ã— atr_val) / activation Ã— 100%
# ä¾‹: (0.15 Ã— 2500) / 95250 Ã— 100% = 0.39%

place_trailing_stop(
    symbol="BTCUSDT",
    side="SELL",           # åšå¤šæ—¶å¹³ä»“=å–å‡º
    quantity=0.0571,       # æ»¡ä»“
    callback_rate=0.39,    # 0.39%å›è°ƒ
    activation_price=95250,
    reduce_only=True
)
```

#### 4.4 æŒ‚3ä¸ªé™ä»·æ­¢ç›ˆå•
```python
# æ­¢ç›ˆ1: 0.35 ATRï¼Œå¹³30%
tp1_price = base_price + (direction Ã— 0.35 Ã— atr_val)  # 95375
tp1_amount = full_amount Ã— 0.3  # 0.0171

place_limit(
    symbol="BTCUSDT",
    side="SELL",
    quantity=0.0171,
    price=95375,
    reduce_only=True
)

# æ­¢ç›ˆ2: 0.45 ATRï¼Œå¹³40%
tp2_price = base_price + (direction Ã— 0.45 Ã— atr_val)  # 95625
tp2_amount = full_amount Ã— 0.4  # 0.0228

place_limit(
    symbol="BTCUSDT",
    side="SELL",
    quantity=0.0228,
    price=95625,
    reduce_only=True
)

# æ­¢ç›ˆ3: 0.6 ATRï¼Œå¹³20%
tp3_price = base_price + (direction Ã— 0.6 Ã— atr_val)  # 96000
tp3_amount = full_amount Ã— 0.2  # 0.0114

place_limit(
    symbol="BTCUSDT",
    side="SELL",
    quantity=0.0114,
    price=96000,
    reduce_only=True
)
```

---

### æ­¥éª¤5: æ£€æµ‹ç¦»åœº (WAIT_EXIT â†’ IDLE)

**è§¦å‘æ¡ä»¶**: æ£€æµ‹åˆ°ä»“ä½ä» >0 å˜ä¸º 0

**æ‰§è¡ŒåŠ¨ä½œ**:
```python
# ä»“ä½å·²æ¸…ç©ºï¼Œç­–ç•¥å®Œæˆ
Log("âœ… æ£€æµ‹åˆ°ä»“ä½æ¸…ç©ºï¼Œç­–ç•¥å®Œæˆ")
_reset()  # é‡ç½®æ‰€æœ‰çŠ¶æ€
```

---

## æŠ€æœ¯å®ç°

### æ ¸å¿ƒç±»

#### 1. `OrderManager` - è®¢å•ç®¡ç†ç±»
å°è£…å¸å®‰æœŸè´§APIè°ƒç”¨ï¼š

```python
class OrderManager:
    def place_market(symbol, side, quantity)
        # å¸‚ä»·å•

    def place_limit(symbol, side, quantity, price, reduce_only)
        # é™ä»·å•

    def place_stop_market(symbol, side, quantity, stop_price, reduce_only)
        # æ­¢æŸå•ï¼ˆSTOP_MARKETï¼‰

    def place_trailing_stop(symbol, side, quantity, callback_rate,
                           activation_price, reduce_only)
        # è·Ÿè¸ªæ­¢ç›ˆå•ï¼ˆTRAILING_STOP_MARKETï¼‰

    def cancel_all_orders(symbol)
        # æ’¤é”€æ‰€æœ‰æŒ‚å•
```

**å…³é”®ç‚¹**:
- æ‰€æœ‰å¹³ä»“è®¢å•å¿…é¡»åŠ  `reduceOnly=true` å‚æ•°
- ä½¿ç”¨ `/fapi/v1/allOpenOrders` ç«¯ç‚¹æ’¤é”€æ‰€æœ‰è®¢å•

#### 2. `PrecisionManager` - ç²¾åº¦ç®¡ç†ç±»
ç®¡ç†äº¤æ˜“å¯¹çš„ä»·æ ¼å’Œæ•°é‡ç²¾åº¦ï¼š

```python
class PrecisionManager:
    def set_precision(symbol)
        # ä»äº¤æ˜“æ‰€è·å–æˆ–ä»ç¼“å­˜åŠ è½½ç²¾åº¦

    def format_price(price)
        # æ ¼å¼åŒ–ä»·æ ¼: _N(price, price_precision)

    def format_amount(amount)
        # æ ¼å¼åŒ–æ•°é‡: _N(amount, amount_precision)
```

#### 3. `OrderBasedStrategyManager` - ç­–ç•¥ç®¡ç†å™¨
æ ¸å¿ƒç­–ç•¥é€»è¾‘ï¼š

```python
class OrderBasedStrategyManager:
    def start_entry(...)
        # æ­¥éª¤1: è®¾ç½®å‚æ•°ï¼Œè¿›å…¥ç¡®è®¤çŠ¶æ€

    def confirm_entry()
        # æ­¥éª¤2: ç¡®è®¤å¼€ä»“ï¼ŒæŒ‚å…¥åœºå•

    def check_position_and_update_state()
        # æ¯2ç§’æ£€æŸ¥ä»“ä½å˜åŒ–ï¼Œè‡ªåŠ¨æ¨è¿›çŠ¶æ€

    def _place_orders_after_base_entry()
        # æ­¥éª¤3: åº•ä»“å»ºç«‹åæŒ‚å•

    def _place_orders_after_full_position()
        # æ­¥éª¤4: æ»¡ä»“åæŒ‚å•
```

### å…³é”®å‡½æ•°

#### `get_atr()` - ATRè®¡ç®—
```python
def get_atr(exchange, symbol, period=20, exclude_today=True):
    # è·å–æ—¥çº¿Kçº¿
    records = exchange.GetRecords(PERIOD_D1)

    # è®¡ç®—ATR
    atr_array = TA.ATR(records, period)

    # ä½¿ç”¨å€’æ•°ç¬¬2æ ¹Kçº¿ï¼ˆæ’é™¤ä»Šæ—¥æœªå®Œæˆï¼‰
    return atr_array[-2]
```

#### ä»“ä½æ£€æŸ¥é€»è¾‘
```python
def check_position_and_update_state(self):
    current_amount, current_price = self._get_position_amount()

    # ä» 0% â†’ 50%
    if self.last == 0 and current â‰ˆ 50%:
        self.state = "ENTRY_DONE"
        self._place_orders_after_base_entry()

    # ä» 50% â†’ 100%
    elif self.last â‰ˆ 50% and current â‰ˆ 100%:
        self.state = "WAIT_EXIT"
        self._place_orders_after_full_position()

    # ä» >0 â†’ 0%
    elif self.last > 0 and current == 0:
        self._reset()

    self.last_position_amount = current_amount
```

---

## æ³¨æ„äº‹é¡¹

### 1. reduceOnly å‚æ•° ğŸ”´
**å…³é”®**: æ‰€æœ‰å¹³ä»“è®¢å•å¿…é¡»åŠ  `reduceOnly=true`ï¼Œå¦åˆ™å¹³å®Œä»“åä¼šåå‘å¼€ä»“ï¼

| è®¢å•ç±»å‹ | reduceOnly | è¯´æ˜ |
|----------|------------|------|
| å…¥åœºå¸‚ä»·/é™ä»·å• | âŒ False | å¼€ä»“ |
| å…¥åœºè·Ÿè¸ªå• | âŒ False | å¼€ä»“ |
| åŠ ä»“è§¦å‘å• | âŒ False | åŠ ä»“ |
| æ­¢æŸå• | âœ… True | å¹³ä»“ |
| è·Ÿè¸ªæ­¢ç›ˆå• | âœ… True | å¹³ä»“ |
| é™ä»·æ­¢ç›ˆå• | âœ… True | å¹³ä»“ |

### 2. å›è°ƒç‡è®¡ç®— ğŸ“Š
å¸å®‰çš„ `callbackRate` å‚æ•°æ˜¯**ç™¾åˆ†æ¯”**ï¼Œéœ€è¦æ­£ç¡®è½¬æ¢ï¼š

```python
# âŒ é”™è¯¯: ç›´æ¥ç”¨ATRå€æ•°å½“ç™¾åˆ†æ¯”
callback_rate = 0.15  # åªæœ‰0.15%ï¼Œå¤ªå°äº†

# âœ… æ­£ç¡®: ATRå€æ•° â†’ è·ç¦» â†’ ç™¾åˆ†æ¯”
callback_distance = 0.15 Ã— atr_val  # å¦‚ 0.15 Ã— 2500 = 375
callback_rate = (callback_distance / activation_price) Ã— 100  # 375/95000 Ã— 100 = 0.39%
```

### 3. æ’¤å•ç«¯ç‚¹
```python
# âŒ é”™è¯¯: å•ä¸ªè®¢å•ç«¯ç‚¹éœ€è¦è®¢å•ID
DELETE /fapi/v1/order?symbol=BTCUSDT
# æŠ¥é”™: Param 'orderid' must be sent

# âœ… æ­£ç¡®: æ’¤é”€æ‰€æœ‰è®¢å•çš„ä¸“ç”¨ç«¯ç‚¹
DELETE /fapi/v1/allOpenOrders?symbol=BTCUSDT
```

### 4. ç²¾åº¦å¤„ç†
æ‰€æœ‰ä»·æ ¼å’Œæ•°é‡å¿…é¡»ä½¿ç”¨ `_N()` å¤„ç†ï¼š

```python
# âŒ é”™è¯¯
price = base_price + 0.6 * atr_val  # å¯èƒ½äº§ç”Ÿè¿‡å¤šå°æ•°

# âœ… æ­£ç¡®
raw_price = base_price + 0.6 * atr_val
price = _N(raw_price, price_precision)  # æ§åˆ¶å°æ•°ä½æ•°
```

### 5. æ£€æŸ¥å®¹å·®
ä»“ä½æ£€æŸ¥æ—¶ä½¿ç”¨å®¹å·®é¿å…ç²¾åº¦è¯¯å·®ï¼š

```python
# âŒ é”™è¯¯: ä¸¥æ ¼ç›¸ç­‰åˆ¤æ–­
if current_amount == expected_base:  # å¯èƒ½æ°¸è¿œä¸ç›¸ç­‰

# âœ… æ­£ç¡®: ä½¿ç”¨å®¹å·®
tolerance = min_amount Ã— 2
if abs(current_amount - expected_base) < tolerance:  # å…è®¸è¯¯å·®
```

### 6. å¸ç§æ ¼å¼è½¬æ¢
```python
# FMZä½¿ç”¨æ ¼å¼: BTC_USDT
symbol = "BTC_USDT"

# å¸å®‰APIæ ¼å¼: BTCUSDT
symbol_for_api = symbol.replace("_", "")  # "BTCUSDT"
```

---

## å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆè¦æ’é™¤ä»Šæ—¥Kçº¿è®¡ç®—ATRï¼Ÿ
**A**: ä»Šæ—¥Kçº¿æœªå®Œæˆï¼Œæ•°æ®ä¸ç¨³å®šã€‚ä½¿ç”¨æ˜¨æ—¥åŠä¹‹å‰20å¤©çš„æ•°æ®è®¡ç®—æ›´å‡†ç¡®ã€‚

```python
atr_array = TA.ATR(records, 20)
atr_val = atr_array[-2]  # å€’æ•°ç¬¬2æ ¹ = æ˜¨æ—¥Kçº¿
```

### Q2: è·Ÿè¸ªå•çš„æ¿€æ´»ä»·å’Œå›è°ƒç‡å¦‚ä½•ç†è§£ï¼Ÿ
**A**:
- **æ¿€æ´»ä»·**: ä»·æ ¼è¾¾åˆ°æ­¤å€¼åï¼Œè·Ÿè¸ªå•æ‰å¼€å§‹å·¥ä½œ
- **å›è°ƒç‡**: ä»æ¿€æ´»åçš„æœ€ä¼˜ä»·å›è°ƒX%æ—¶è§¦å‘

**ä¾‹å­ï¼ˆåšå¤šï¼‰**:
- æ¿€æ´»ä»· = 95250
- å›è°ƒç‡ = 0.5%
- ä»·æ ¼æ¶¨åˆ° 95250 â†’ æ¿€æ´»
- ä»·æ ¼ç»§ç»­æ¶¨åˆ° 96000ï¼ˆæœ€é«˜ç‚¹ï¼‰
- ä»·æ ¼å›è½åˆ° 95520ï¼ˆ96000 Ã— 99.5%ï¼‰â†’ è§¦å‘å–å‡º

### Q3: ä¸ºä»€ä¹ˆæ»¡ä»“åæ­¢æŸä» -0.6 ATR å˜ä¸º -0.3 ATRï¼Ÿ
**A**: åŠ ä»“åå·²ç»ç›ˆåˆ©ï¼Œæ­¢æŸå¯ä»¥æ›´ç´§ï¼Œä¿æŠ¤åˆ©æ¶¦ï¼š
- åº•ä»“æ­¢æŸ -0.6 ATRï¼šå®¹å¿è¾ƒå¤§æ³¢åŠ¨
- æ»¡ä»“æ­¢æŸ -0.3 ATRï¼šå·²ç›ˆåˆ©ï¼Œæ”¶ç´§æ­¢æŸ

### Q4: å¦‚æœå…¥åœºå•ä¸€ç›´ä¸æˆäº¤æ€ä¹ˆåŠï¼Ÿ
**A**: ç­–ç•¥ä¼šä¿æŒåœ¨ `WAIT_ENTRY` çŠ¶æ€ï¼Œå¯ä»¥ï¼š
1. ç­‰å¾…ä»·æ ¼è§¦è¾¾
2. ç‚¹å‡»"å–æ¶ˆ"æŒ‰é’®ï¼Œé‡æ–°è®¾ç½®å‚æ•°
3. æ‰‹åŠ¨åœ¨äº¤æ˜“æ‰€æ’¤å•åé‡ç½®ç­–ç•¥

### Q5: å¦‚æœæ­¢æŸå’Œæ­¢ç›ˆåŒæ—¶è§¦å‘ä¼šæ€æ ·ï¼Ÿ
**A**: äº¤æ˜“æ‰€æŒ‰è®¢å•åˆ›å»ºæ—¶é—´å…ˆåæ‰§è¡Œï¼Œå…ˆåˆ›å»ºçš„å…ˆæˆäº¤ã€‚æœ¬ç­–ç•¥ä¸­ï¼š
- æ­¢æŸå•æœ€å…ˆåˆ›å»ºï¼ˆæ­¥éª¤3æˆ–4ï¼‰
- æ­¢ç›ˆå•ååˆ›å»ºï¼ˆæ­¥éª¤4ï¼‰
- æ‰€ä»¥æ­¢æŸä¼˜å…ˆçº§æ›´é«˜

### Q6: æ¨¡æ‹Ÿç›˜å‚æ•°ä¸ºä»€ä¹ˆç¼©å°20å€ï¼Ÿ
**A**: ä¸ºäº†å¿«é€Ÿè§¦å‘æµ‹è¯•ï¼š
- å®ç›˜ 0.6 ATR â‰ˆ 1500 USDTæ³¢åŠ¨
- æ¨¡æ‹Ÿç›˜ 0.03 ATR â‰ˆ 75 USDTæ³¢åŠ¨
- æ–¹ä¾¿åœ¨å‡ åˆ†é’Ÿå†…å®Œæˆå®Œæ•´æµ‹è¯•

### Q7: å¦‚æœåŠ ä»“å•æˆäº¤äº†ï¼Œä½†Pythonä»£ç æ²¡æ£€æµ‹åˆ°æ€ä¹ˆåŠï¼Ÿ
**A**: æ¯2ç§’ä¼šé‡æ–°æ£€æŸ¥çœŸå®æŒä»“ï¼Œå³ä½¿æ¼æ£€ä¸€æ¬¡ï¼Œä¸‹ä¸€æ¬¡ä¹Ÿä¼šè¡¥ä¸Šï¼š
```python
# å³ä½¿ç¬¬1æ¬¡æ£€æŸ¥æ—¶æ¼äº†ï¼Œç¬¬2æ¬¡æ£€æŸ¥ä»ä¼šè§¦å‘
if last â‰ˆ 50% and now â‰ˆ 100%:
    # æ‰§è¡Œæ­¥éª¤4
```

---

## éƒ¨ç½²æ¸…å•

### éƒ¨ç½²å‰æ£€æŸ¥
- [ ] ç¡®è®¤ `REAL` å‚æ•°è®¾ç½®ï¼ˆå®ç›˜=Trueï¼Œæ¨¡æ‹Ÿç›˜=Falseï¼‰
- [ ] æ£€æŸ¥ `MY_SYMBOLS` åˆ—è¡¨ä¸­åŒ…å«è¦äº¤æ˜“çš„å¸ç§
- [ ] ç¡®è®¤å¸å®‰API KEYå·²é…ç½®ä¸”æœ‰æœŸè´§äº¤æ˜“æƒé™
- [ ] æµ‹è¯•ç½‘ç»œè¿æ¥å’ŒAPIè®¿é—®

### é¦–æ¬¡è¿è¡Œå»ºè®®
1. å…ˆç”¨æ¨¡æ‹Ÿç›˜æµ‹è¯•ï¼ˆ`REAL=False`ï¼‰
2. ä½¿ç”¨å°é¢èµ„é‡‘ï¼ˆå¦‚ max_loss=10 USDTï¼‰
3. é€‰æ‹©å¸‚ä»·å…¥åœºæ¨¡å¼ï¼ˆæœ€ç®€å•ï¼‰
4. è§‚å¯Ÿæ—¥å¿—ï¼Œç¡®è®¤æ‰€æœ‰è®¢å•æ­£å¸¸æŒ‚å‡º
5. æ‰‹åŠ¨è§¦å‘ä¸€æ¬¡å®Œæ•´æµç¨‹éªŒè¯

### ç›‘æ§è¦ç‚¹
- è§‚å¯ŸçŠ¶æ€è½¬æ¢æ˜¯å¦æ­£å¸¸
- æ£€æŸ¥è®¢å•æ˜¯å¦æˆåŠŸæŒ‚å‡º
- ç¡®è®¤ `reduceOnly` å‚æ•°æ­£ç¡®
- éªŒè¯ä»·æ ¼è®¡ç®—ç²¾åº¦
- ç›‘æ§ä»“ä½åŒæ­¥å‡†ç¡®æ€§

---

## ç‰ˆæœ¬å†å²

### v1.0 (2024-12-18)
- âœ… å®ç°åŸºäºæŒ‚å•çš„å®Œæ•´ç­–ç•¥é€»è¾‘
- âœ… æ”¯æŒ4ç§å…¥åœºæ¨¡å¼
- âœ… è‡ªåŠ¨ä»“ä½æ£€æµ‹å’ŒçŠ¶æ€æ¨è¿›
- âœ… å®Œæ•´çš„æ­¢æŸ/åŠ ä»“/æ­¢ç›ˆè®¢å•ç®¡ç†
- âœ… ç²¾åº¦ç®¡ç†å’Œç¼“å­˜æœºåˆ¶
- âœ… å®ç›˜/æ¨¡æ‹Ÿç›˜å‚æ•°åˆ‡æ¢

---

## ç›¸å…³æ–‡ä»¶
- `order_based_strategy.py` - ä¸»ç­–ç•¥æ–‡ä»¶
- `all_in_one.py` - åŸå®æ—¶ç›‘æ§ç‰ˆæœ¬ç­–ç•¥
- `simple_manage.py` - åŸºç¡€è®¢å•ç®¡ç†ç¤ºä¾‹
- `CLAUDE.md` - é¡¹ç›®æ€»ä½“è¯´æ˜æ–‡æ¡£

---

**ä½œè€…**: Claude Code
**æœ€åæ›´æ–°**: 2024-12-18
**FMZå¹³å°**: https://www.fmz.com
